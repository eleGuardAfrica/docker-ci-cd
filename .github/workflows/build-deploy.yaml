name: Build and Deploy

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
  workflow_dispatch:

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Determine Web App Name
      id: config
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "webapp_name=${{ secrets.WEBAPP_NAME }}" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
        else
          echo "webapp_name=${{ secrets.WEBAPP_NAME }}" >> $GITHUB_OUTPUT
          echo "environment=staging" >> $GITHUB_OUTPUT
        fi

    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_LOGIN_SERVER }}
        username: ${{ env.REGISTRY_USERNAME }}
        password: ${{ env.REGISTRY_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY_LOGIN_SERVER }}/${{ steps.config.outputs.webapp_name }}:latest
          ${{ env.REGISTRY_LOGIN_SERVER }}/${{ steps.config.outputs.webapp_name }}:${{ github.sha }}

    - name: Deployment Summary
      run: |
        echo "âœ… Deployed to: ${{ steps.config.outputs.environment }}"
        echo "ðŸ“¦ Web App: ${{ steps.config.outputs.webapp_name }}"
        echo "ðŸ”— Image: ${{ env.REGISTRY_LOGIN_SERVER }}/${{ steps.config.outputs.webapp_name }}:latest"